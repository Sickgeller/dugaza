<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.cart.dao.CartMapper">
    
    <resultMap id="cartItemMap" type="kr.spring.cart.vo.CartItemVO">
        <id property="cartItemId" column="CART_ITEM_ID"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="itemType" column="ITEM_TYPE"/>
        <result property="itemId" column="ITEM_ID"/>
        <result property="startDate" column="START_DATE"/>
        <result property="endDate" column="END_DATE"/>
        <result property="quantity" column="QUANTITY"/>
        <result property="unitPrice" column="UNIT_PRICE"/>
        <result property="totalPrice" column="TOTAL_PRICE"/>
        <result property="itemName" column="ITEM_NAME"/>
        <result property="itemImage" column="ITEM_IMAGE"/>
        <result property="itemTypeName" column="ITEM_TYPE_NAME"/>
        <result property="pickupLocation" column="PICKUP_LOCATION"/>
        <result property="returnLocation" column="RETURN_LOCATION"/>
        <result property="roomType" column="ROOM_TYPE"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <insert id="insertCartItem" parameterType="kr.spring.cart.vo.CartItemVO">
        INSERT INTO CART_ITEM (
            CART_ITEM_ID, MEMBER_ID, ITEM_TYPE, ITEM_ID, START_DATE, END_DATE,
            QUANTITY, UNIT_PRICE, TOTAL_PRICE, ITEM_NAME, ITEM_IMAGE, ITEM_TYPE_NAME,
            PICKUP_LOCATION, RETURN_LOCATION, ROOM_TYPE, CREATED_AT, UPDATED_AT
        ) VALUES (
            #{cartItemId}, #{memberId}, #{itemType}, #{itemId}, #{startDate}, #{endDate},
            #{quantity}, #{unitPrice}, #{totalPrice}, #{itemName}, #{itemImage}, #{itemTypeName},
            #{pickupLocation}, #{returnLocation}, #{roomType}, SYSDATE, SYSDATE
        )
    </insert>

    <update id="updateCartItem" parameterType="kr.spring.cart.vo.CartItemVO">
        UPDATE CART_ITEM SET
            START_DATE = #{startDate},
            END_DATE = #{endDate},
            QUANTITY = #{quantity},
            UNIT_PRICE = #{unitPrice},
            TOTAL_PRICE = #{totalPrice},
            PICKUP_LOCATION = #{pickupLocation},
            RETURN_LOCATION = #{returnLocation},
            UPDATED_AT = SYSDATE
        WHERE CART_ITEM_ID = #{cartItemId}
    </update>

    <delete id="deleteCartItem" parameterType="string">
        DELETE FROM CART_ITEM WHERE CART_ITEM_ID = #{cartItemId}
    </delete>

    <select id="selectCartItemsByMember" parameterType="long" resultMap="cartItemMap">
        SELECT * FROM CART_ITEM 
        WHERE MEMBER_ID = #{memberId}
        ORDER BY CREATED_AT DESC
    </select>

    <select id="selectCartItem" parameterType="string" resultMap="cartItemMap">
        SELECT * FROM CART_ITEM WHERE CART_ITEM_ID = #{cartItemId}
    </select>

    <delete id="clearCartByMember" parameterType="long">
        DELETE FROM CART_ITEM WHERE MEMBER_ID = #{memberId}
    </delete>

    <select id="checkCartItemExists" resultType="int">
        SELECT COUNT(*) FROM CART_ITEM 
        WHERE MEMBER_ID = #{memberId} 
        AND ITEM_TYPE = #{itemType} 
        AND ITEM_ID = #{itemId}
    </select>

</mapper> 