<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_basic}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>숙소 예약 - 드가자닷컴</title>
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/accommodation-detail.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .reservation-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 70px;
        }
        
        .reservation-header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .reservation-header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .reservation-header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
        }
        
        .reservation-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }
        
        .reservation-form {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .form-section {
            margin-bottom: 35px;
            padding: 25px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: #fafbfc;
        }
        
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-section h3 i {
            color: #3498db;
            font-size: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* 객실 타입 버튼 개선 */
        .room-type-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .room-type-btn {
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            background: white;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .room-type-btn:hover {
            border-color: #3498db;
            color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }
        
        .room-type-btn.active {
            background: #3498db;
            border-color: #3498db;
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .room-type-btn .room-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .room-type-btn:not(.active) .room-count {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        /* 객실 옵션 개선 */
        .room-options {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
        }
        
        .room-option {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .room-option:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        
        .room-option.selected {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }
        
        .room-option.unavailable {
            opacity: 0.6;
            background-color: #f8f9fa;
            cursor: not-allowed;
            position: relative;
        }
        
        .room-option.unavailable::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.05);
            z-index: 1;
            pointer-events: none;
        }
        
        .room-option.unavailable .room-info {
            pointer-events: none;
        }
        
        .room-option.unavailable:hover {
            background-color: #f8f9fa;
            transform: none;
        }
        
        .room-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-details h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .room-details p {
            margin: 0 0 5px 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .room-price {
            text-align: right;
        }
        
        .room-price .price {
            font-size: 1.3rem;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .room-price .per-night {
            font-size: 12px;
            color: #95a5a6;
        }
        
        .availability-status {
            position: absolute;
            top: 10px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .availability-status.available {
            background: #d4edda;
            color: #155724;
        }
        
        .availability-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* 예약 요약 개선 */
        .reservation-summary {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .summary-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .summary-header h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }
        
        .house-info {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
        }
        
        .house-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }
        
        .house-details h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .house-details p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .price-breakdown {
            margin-bottom: 25px;
        }
        
        .price-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .price-item.total {
            border-top: 2px solid #3498db;
            padding-top: 15px;
            font-weight: bold;
            font-size: 1.2rem;
            color: #2c3e50;
        }
        
        .reservation-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .reservation-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .reservation-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 특별 요청사항 개선 */
        .special-requests textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            resize: vertical;
            min-height: 100px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .special-requests textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 3% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255,255,255,0.2);
            overflow: hidden;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-60px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-header h3::before {
            content: '✓';
            background: rgba(255,255,255,0.2);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            color: white;
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
            background: white;
        }
        
        .modal-body p {
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            line-height: 1.6;
        }
        
        #confirmDetails {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            margin: 20px 0;
        }
        
        #confirmDetails p {
            margin: 12px 0;
            color: #34495e;
            font-size: 0.95rem;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        #confirmDetails p:last-child {
            border-bottom: none;
        }
        
        #confirmDetails strong {
            color: #2c3e50;
            font-weight: 600;
            min-width: 100px;
        }
        
        #confirmDetails .price-highlight {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .modal-footer {
            padding: 25px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid #e9ecef;
        }
        
        .btn-cancel, .btn-confirm {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        
        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }
        
        .btn-confirm {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-confirm:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-confirm::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-confirm:hover::before {
            left: 100%;
        }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .reservation-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .date-inputs {
                grid-template-columns: 1fr;
            }
            
            .room-type-buttons {
                justify-content: center;
            }
            
            .room-type-btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
            
            .reservation-summary {
                position: static;
                margin-top: 20px;
            }
            
            .reservation-header h1 {
                font-size: 2rem;
            }
        }
        
        /* 선택된 객실 정보 스타일 */
        .selected-room-info {
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
        }
        
        .selected-room-info h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .selected-room-info h4::before {
            content: '🏠';
            font-size: 1.2rem;
        }
        
        .selected-room-info p {
            margin: 10px 0;
            color: #34495e;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-room-info strong {
            color: #2c3e50;
            font-weight: 600;
            min-width: 80px;
        }
    </style>
</head>
<body>
<main layout:fragment="content">
    <div class="reservation-container">
        <div class="reservation-header">
            <h1>숙소 예약</h1>
            <p>편안한 숙박을 위한 예약을 진행해주세요</p>
        </div>
        
        <div class="reservation-content">
            <!-- 예약 폼 -->
            <div class="reservation-form">
                <form id="reservationForm" th:action="@{/reservation/house/book}" method="post">
                    <input type="hidden" name="houseId" th:value="${contentId}" />
                    <input type="hidden" name="roomId" id="selectedRoomId" />
                    <input type="hidden" name="reservationStart" id="reservationStart" />
                    <input type="hidden" name="reservationEnd" id="reservationEnd" />
                    <input type="hidden" name="reservationCount" id="reservationCount" />
                    <input type="hidden" name="price" id="reservationPrice" />
                    <input type="hidden" name="status" value="0" />
                    
                    <!-- 날짜 선택 -->
                    <div class="form-section">
                        <h3><i class="fas fa-calendar"></i> 날짜 선택</h3>
                        <div class="date-inputs">
                            <div class="form-group">
                                <label for="checkInDate">체크인</label>
                                <input type="date" id="checkInDate" name="checkInDate" required>
                            </div>
                            <div class="form-group">
                                <label for="checkOutDate">체크아웃</label>
                                <input type="date" id="checkOutDate" name="checkOutDate" required>
                            </div>
                        </div>
                    </div>
                    
                 
                    
                    <!-- 객실 선택 -->
                    <div class="form-section">
                        <h3><i class="fas fa-bed"></i> 객실 선택</h3>
                        
                        <!-- 객실 타입 선택 -->
                        <div class="room-type-selection" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">객실 타입 선택</label>
                            <div class="room-type-buttons" id="roomTypeButtons">
                                <!-- 객실 타입 버튼들이 동적으로 생성됨 -->
                            </div>
                        </div>
                        
                        <!-- 선택된 타입의 객실 목록 -->
                        <div class="room-options" id="roomOptions">
                            <!-- 객실이 없을 경우 -->
                            <div th:if="${#lists.isEmpty(roomList)}" class="no-rooms">
                                <p>등록된 객실이 없습니다.</p>
                            </div>
                            
                            <!-- 기존 객실 목록 (JavaScript에서 동적으로 처리됨) -->
                            <div class="room-option" th:each="room : ${roomList}" 
                                 th:data-room-id="${room.roomId}" 
                                 th:data-price="${room.price}"
                                 th:data-room-name="${room.roomName}"
                                 th:data-room-type="${room.roomType}"
                                 th:data-room-size="${room.roomSize}"
                                 th:data-min-capacity="${room.minimumCapacity}"
                                 th:data-max-capacity="${room.maximumCapacity}"
                                 th:data-bed-info="${room.bedInfo}"
                                 th:data-description="${room.description}"
                                 style="display: none;">
                            </div>
                        </div>
                    </div>

                       <!-- 인원 선택 -->
                    <div class="form-section">
                        <h3><i class="fas fa-users"></i> 인원 선택</h3>
                        <div class="form-group">
                            <label for="guestCount">투숙 인원</label>
                            <select id="guestCount" name="guestCount" required>
                                <option value="">객실을 먼저 선택해주세요</option>
                            </select>
                            <small class="capacity-info" id="capacityInfo" style="display: none; color: #666; margin-top: 5px;">
                                <!-- 수용 인원 정보가 여기에 표시됨 -->
                            </small>
                        </div>
                    </div>
                    
                    <!-- 투숙객 정보 -->
                    <!-- <div class="form-section">
                        <h3><i class="fas fa-user"></i> 투숙객 정보</h3>
                        <div class="guest-info">
                            <h4>대표 투숙객 정보</h4>
                            <div class="guest-fields">
                                <div class="form-group">
                                    <label for="guestName">이름</label>
                                    <input type="text" id="guestName" name="guestName" required>
                                </div>
                                <div class="form-group">
                                    <label for="guestPhone">연락처</label>
                                    <input type="tel" id="guestPhone" name="guestPhone" required>
                                </div>
                                <div class="form-group">
                                    <label for="guestEmail">이메일</label>
                                    <input type="email" id="guestEmail" name="guestEmail" required>
                                </div>
                                <div class="form-group">
                                    <label for="guestIdCard">주민등록번호</label>
                                    <input type="text" id="guestIdCard" name="guestIdCard" placeholder="000000-0000000" required>
                                </div>
                            </div>
                        </div>
                    </div>
                     -->
                    <!-- 특별 요청사항 -->
                    <div class="form-section">
                        <h3><i class="fas fa-comment"></i> 특별 요청사항</h3>
                        <div class="special-requests">
                            <textarea name="specialRequests" placeholder="특별한 요청사항이 있으시면 입력해주세요. (선택사항)"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- 예약 요약 -->
            <div class="reservation-summary">
                <div class="summary-header">
                    <h3>예약 요약</h3>
                </div>
                
                <!-- 숙소 정보 -->
                <div class="house-info">
                    <img th:src="${houseInfo.firstImage}" alt="숙소 이미지" class="house-image">
                    <div class="house-details">
                        <h4 th:text="${houseInfo.title}">숙소명</h4>
                        <p th:text="${houseInfo.addr1}">주소</p>
                    </div>
                </div>
                
                <!-- 가격 내역 -->
                <div class="price-breakdown">
                    <div class="price-item">
                        <span>객실 요금</span>
                        <span id="roomPrice">-</span>
                    </div>
                    <div class="price-item">
                        <span>숙박일수</span>
                        <span id="nights">-</span>
                    </div>
                    <div class="price-item">
                        <span>세금 및 수수료</span>
                        <span id="taxFee">-</span>
                    </div>
                    <div class="price-item total">
                        <span>총 결제금액</span>
                        <span id="totalPrice">-</span>
                    </div>
                </div>
                
                <!-- 예약 버튼 -->
                <button type="button" id="reservationBtn" class="reservation-btn" disabled>
                    예약하기
                </button>
                
                <!-- 예약 안내 -->
                <div style="margin-top: 20px; font-size: 12px; color: #666;">
                    <p><i class="fas fa-info-circle"></i> 예약 완료 후 결제가 진행됩니다.</p>
                    <p><i class="fas fa-clock"></i> 체크인 3일 전까지 무료 취소 가능합니다.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 예약 확인 모달 -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>예약 확인</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>아래 내용으로 예약을 진행하시겠습니까?</p>
                <div id="confirmDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel">
                    <i class="fas fa-times"></i> 취소
                </button>
                <button type="button" class="btn-confirm">
                    <i class="fas fa-check"></i> 예약 확정
                </button>
            </div>
        </div>
    </div>
    
    <script th:src="@{/assets/js/jquery-3.7.1.min.js}"></script>
    <script th:inline="javascript">
        // Thymeleaf에서 houseInfo 데이터 가져오기
        const houseInfo = /*[[${houseInfo}]]*/ {};
        
        $(document).ready(function() {
            const checkInDate = $('#checkInDate');
            const checkOutDate = $('#checkOutDate');
            const guestCount = $('#guestCount');
            const roomOptions = $('#roomOptions');
            const roomTypeButtons = $('#roomTypeButtons');
            const reservationBtn = $('#reservationBtn');
            
            let selectedRoom = null;
            let roomData = [];
            
            // 페이지 로드 시 객실 데이터 초기화
            function initializeRoomData() {
                $('.room-option').each(function() {
                    const room = {
                        roomId: $(this).data('room-id'),
                        roomName: $(this).data('room-name'),
                        roomType: $(this).data('room-type'),
                        price: $(this).data('price'),
                        roomSize: $(this).data('room-size'),
                        minimumCapacity: $(this).data('min-capacity') || 1,
                        maximumCapacity: $(this).data('max-capacity'),
                        bedInfo: $(this).data('bed-info'),
                        description: $(this).data('description')
                    };
                    roomData.push(room);
                });
                
                // 객실 타입별로 그룹화하여 버튼 생성
                const roomTypes = [...new Set(roomData.map(room => room.roomType))];
                
                roomTypes.forEach(type => {
                    const roomsOfType = roomData.filter(room => room.roomType === type);
                    const button = $(`
                        <button type="button" class="room-type-btn" data-type="${type}">
                            <i class="fas fa-bed"></i>
                            <span>${type}</span>
                            <span class="room-count">${roomsOfType.length}</span>
                        </button>
                    `);
                    roomTypeButtons.append(button);
                });
                
                // 첫 번째 타입 자동 선택
                if (roomTypes.length > 0) {
                    $('.room-type-btn').first().addClass('active');
                    updateRoomList(roomTypes[0]);
                }
            }
            
            // 객실 타입 버튼 클릭 이벤트
            $(document).on('click', '.room-type-btn', function() {
                if ($(this).hasClass('disabled')) return;
                
                $('.room-type-btn').removeClass('active');
                $(this).addClass('active');
                
                const selectedType = $(this).data('type');
                updateRoomList(selectedType);
                
                // 선택된 객실 초기화
                selectedRoom = null;
                $('.room-option').removeClass('selected');
                updateGuestCountOptions();
                calculatePrice();
            });
            
            // 객실 목록 업데이트
            function updateRoomList(type) {
                roomOptions.empty();
                
                const roomsOfType = roomData.filter(room => room.roomType === type);
                
                if (roomsOfType.length === 0) {
                    roomOptions.html('<div class="no-rooms"><p>해당 타입의 객실이 없습니다.</p></div>');
                    return;
                }
                
                // 객실 그룹 헤더
                const groupHeader = $(`
                    <div class="room-group-header">
                        <h4>${type}</h4>
                        <p>${roomsOfType.length}개의 객실 중 선택하세요</p>
                    </div>
                `);
                roomOptions.append(groupHeader);
                
                // 객실 목록
                const roomGroup = $('<div class="room-group active"></div>');
                
                roomsOfType.forEach(room => {
                    const roomElement = $(`
                        <div class="room-option" 
                             data-room-id="${room.roomId}" 
                             data-price="${room.price}"
                             data-room-name="${room.roomName}"
                             data-room-type="${room.roomType}"
                             data-room-size="${room.roomSize}"
                             data-min-capacity="${room.minimumCapacity}"
                             data-max-capacity="${room.maximumCapacity}"
                             data-bed-info="${room.bedInfo}"
                             data-description="${room.description}">
                            <div class="room-info">
                                <div class="room-details">
                                    <h4>${room.roomName}</h4>
                                    <p>최소 ${room.minimumCapacity}명 ~ 최대 ${room.maximumCapacity}명 / ${room.roomSize}㎡</p>
                                    <p>${room.bedInfo}</p>
                                    ${room.description ? `<p>${room.description}</p>` : ''}
                                </div>
                                <div class="room-price">
                                    <div class="price">${room.price.toLocaleString()}원</div>
                                    <div class="per-night">1박 기준</div>
                                </div>
                            </div>
                        </div>
                    `);
                    roomGroup.append(roomElement);
                });
                
                roomOptions.append(roomGroup);
            }
            
            // 최소 체크인 날짜를 오늘로 설정
            const today = new Date().toISOString().split('T')[0];
            checkInDate.attr('min', today);
            
            // 페이지 로드 시 객실 데이터 초기화
            initializeRoomData();
            
            // 날짜 변경 시 예약 가능 여부 확인
            checkInDate.on('change', function() {
                if (checkInDate.val() && checkOutDate.val() && guestCount.val()) {
                    checkRoomAvailability();
                }
                calculatePrice();
            });
            
            checkOutDate.on('change', function() {
                if (checkInDate.val() && checkOutDate.val() && guestCount.val()) {
                    checkRoomAvailability();
                }
                calculatePrice();
            });
            
            // 인원 변경 시 예약 가능 여부 확인
            guestCount.on('change', function() {
                if (checkInDate.val() && checkOutDate.val() && guestCount.val()) {
                    checkRoomAvailability();
                }
                calculatePrice();
            });
            
            // 객실 선택 이벤트
            $(document).on('click', '.room-option', function() {
                // 예약 불가능한 객실은 선택 불가
                if ($(this).hasClass('unavailable')) {
                    alert('해당 객실은 선택할 수 없습니다. 다른 객실을 선택해주세요.');
                    return false;
                }
                
                // 기존 선택 해제
                $('.room-option').removeClass('selected');
                
                // 현재 객실 선택
                $(this).addClass('selected');
                
                // 선택된 객실 정보 저장
                selectedRoom = {
                    roomId: $(this).data('room-id'),
                    roomName: $(this).data('room-name'),
                    roomType: $(this).data('room-type'),
                    price: $(this).data('price'),
                    roomSize: $(this).data('room-size'),
                    minimumCapacity: $(this).data('min-capacity') || 1,
                    maximumCapacity: $(this).data('max-capacity'),
                    bedInfo: $(this).data('bed-info'),
                    description: $(this).data('description')
                };
                
                // 인원 선택 옵션 업데이트
                updateGuestCountOptions();
                
                calculatePrice();
                updateRoomInfo();
            });
            
            // 인원 선택 옵션 업데이트
            function updateGuestCountOptions() {
                if (!selectedRoom) {
                    guestCount.html('<option value="">객실을 먼저 선택해주세요</option>');
                    $('#capacityInfo').hide();
                    return;
                }
                
                const minCapacity = selectedRoom.minimumCapacity;
                const maxCapacity = selectedRoom.maximumCapacity;
                
                // 기존 옵션 제거
                guestCount.empty();
                
                // 기본 옵션 추가
                guestCount.append('<option value="">인원을 선택하세요</option>');
                
                // 최소 인원부터 최대 인원까지 옵션 생성
                for (let i = minCapacity; i <= maxCapacity; i++) {
                    guestCount.append(`<option value="${i}">${i}명</option>`);
                }
                
                // 수용 인원 정보 표시
                const capacityInfo = `수용 가능 인원: ${minCapacity}명 ~ ${maxCapacity}명`;
                $('#capacityInfo').text(capacityInfo).show();
                
                // 기존 선택값 초기화
                guestCount.val('');
            }
            
            // 예약 가능 여부 확인
            function checkRoomAvailability() {
                const contentId = $('input[name="houseId"]').val();
                const checkIn = checkInDate.val();
                const checkOut = checkOutDate.val();
                const guests = guestCount.val();
                
                if (!contentId || !checkIn || !checkOut || !guests) {
                    return;
                }
                
                // 모든 객실에 로딩 표시
                $('.room-option').addClass('checking');
                
                // AJAX로 예약 가능한 객실 확인
                $.ajax({
                    url: '/api/rooms/available',
                    method: 'GET',
                    data: {
                        contentId: contentId,
                        checkIn: checkIn,
                        checkOut: checkOut,
                        guestCount: guests
                    },
                    success: function(response) {
                        if (response.success) {
                            const availableRoomIds = response.rooms.map(room => room.roomId);
                            
                            // 각 객실의 예약 가능 여부 업데이트
                            $('.room-option').each(function() {
                                const roomId = $(this).data('room-id');
                                const isAvailable = availableRoomIds.includes(roomId);
                                
                                $(this).removeClass('checking');
                                
                                if (isAvailable) {
                                    $(this).removeClass('unavailable').addClass('available');
                                    $(this).find('.availability-status').remove();
                                    $(this).append('<div class="availability-status available">예약 가능</div>');
                                } else {
                                    $(this).removeClass('available').addClass('unavailable');
                                    $(this).find('.availability-status').remove();
                                    $(this).append('<div class="availability-status unavailable">예약 불가</div>');
                                }
                            });
                            
                            // 객실 타입 버튼의 예약 가능 개수 업데이트
                            updateRoomTypeAvailability(availableRoomIds);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('.room-option').removeClass('checking');
                        alert('예약 가능 여부를 확인하는데 실패했습니다.');
                    }
                });
            }
            
            // 객실 타입별 예약 가능 개수 업데이트
            function updateRoomTypeAvailability(availableRoomIds) {
                $('.room-type-btn').each(function() {
                    const type = $(this).data('type');
                    const roomsOfType = roomData.filter(room => room.roomType === type);
                    const availableCount = roomsOfType.filter(room => 
                        availableRoomIds.includes(room.roomId)
                    ).length;
                    
                    const countElement = $(this).find('.room-count');
                    countElement.text(`${availableCount}/${roomsOfType.length}`);
                    
                    // 예약 가능한 객실이 없으면 버튼 비활성화
                    if (availableCount === 0) {
                        $(this).addClass('disabled').prop('disabled', true);
                    } else {
                        $(this).removeClass('disabled').prop('disabled', false);
                    }
                });
            }
            
            // 가격 계산
            function calculatePrice() {
                const selectedRoom = $('.room-option.selected');
                if (selectedRoom.length === 0) {
                    $('#roomPrice').text('-');
                    $('#nights').text('-');
                    $('#taxFee').text('-');
                    $('#totalPrice').text('-');
                    reservationBtn.prop('disabled', true);
                    return;
                }
                
                const roomPrice = parseInt(selectedRoom.data('price'));
                const nights = calculateNights();
                const totalRoomPrice = roomPrice * nights;
                const taxFee = Math.round(totalRoomPrice * 0.1); // 10% 세금
                const totalPrice = totalRoomPrice + taxFee;
                
                $('#roomPrice').text(totalRoomPrice.toLocaleString() + '원');
                $('#nights').text(nights + '박');
                $('#taxFee').text(taxFee.toLocaleString() + '원');
                $('#totalPrice').text(totalPrice.toLocaleString() + '원');
                
                reservationBtn.prop('disabled', false);
            }
            
            // 선택된 객실 정보 업데이트
            function updateRoomInfo() {
                const selectedRoom = $('.room-option.selected');
                if (selectedRoom.length === 0) {
                    return;
                }
                
                const roomName = selectedRoom.data('room-name');
                const roomSize = selectedRoom.data('room-size');
                const maxCapacity = selectedRoom.data('max-capacity');
                const bedInfo = selectedRoom.data('bed-info');
                const description = selectedRoom.data('description');
                
                // 기존 선택된 객실 정보 제거
                $('.selected-room-info').remove();
                
                // 예약 요약에 선택된 객실 정보 표시
                $('.house-info').after(`
                    <div class="selected-room-info">
                        <h4>선택된 객실</h4>
                        <p><strong>객실명:</strong> ${roomName}</p>
                        <p><strong>크기:</strong> ${roomSize}㎡</p>
                        <p><strong>최대 인원:</strong> ${maxCapacity}명</p>
                        <p><strong>침대:</strong> ${bedInfo}</p>
                        ${description ? `<p><strong>설명:</strong> ${description}</p>` : ''}
                    </div>
                `);
            }
            
            // 숙박 일수 계산
            function calculateNights() {
                if (!checkInDate.val() || !checkOutDate.val()) return 0;
                
                const checkIn = new Date(checkInDate.val());
                const checkOut = new Date(checkOutDate.val());
                const diffTime = checkOut - checkIn;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays;
            }
            
            // 예약 버튼 클릭
            reservationBtn.on('click', function() {
                if (!validateForm()) {
                    return;
                }
                
                showConfirmModal();
            });
            
            // 폼 검증
            function validateForm() {
                if (!checkInDate.val()) {
                    alert('체크인 날짜를 선택해주세요.');
                    return false;
                }
                if (!checkOutDate.val()) {
                    alert('체크아웃 날짜를 선택해주세요.');
                    return false;
                }
                if (!guestCount.val()) {
                    alert('투숙 인원을 선택해주세요.');
                    return false;
                }
                if ($('.room-option.selected').length === 0) {
                    alert('객실을 선택해주세요.');
                    return false;
                }
                
                // 선택된 인원이 객실 수용 범위 내에 있는지 확인
                if (selectedRoom) {
                    const selectedGuestCount = parseInt(guestCount.val());
                    const minCapacity = selectedRoom.minimumCapacity;
                    const maxCapacity = selectedRoom.maximumCapacity;
                    
                    if (selectedGuestCount < minCapacity || selectedGuestCount > maxCapacity) {
                        alert(`선택하신 객실은 ${minCapacity}명 ~ ${maxCapacity}명까지 수용 가능합니다.`);
                        return false;
                    }
                }
                return true;
            }
            
            // 확인 모달 표시
            function showConfirmModal() {
                const selectedRoom = $('.room-option.selected');
                const roomName = selectedRoom.data('room-name');
                const totalPrice = $('#totalPrice').text();
                const nights = $('#nights').text();
                const guestCount = $('#guestCount').val();
                
                const checkInTime = houseInfo.checkInTime || '15:00';
                const checkOutTime = houseInfo.checkOutTime || '11:00';
                
                const confirmDetails = `
                    <div style="margin: 20px 0;">
                        <p><strong>숙소명</strong><span>${$('.house-details h4').text()}</span></p>
                        <p><strong>객실명</strong><span>${roomName}</span></p>
                        <p><strong>체크인</strong><span>${checkInDate.val()} ${checkInTime}</span></p>
                        <p><strong>체크아웃</strong><span>${checkOutDate.val()} ${checkOutTime}</span></p>
                        <p><strong>숙박일수</strong><span>${nights}</span></p>
                        <p><strong>투숙 인원</strong><span>${guestCount}명</span></p>
                        <p><strong>총 결제금액</strong><span class="price-highlight">${totalPrice}</span></p>
                    </div>
                `;
                
                $('#confirmDetails').html(confirmDetails);
                $('#confirmModal').fadeIn(300);
            }
            
            // 모달 닫기
            $('.close-modal, .btn-cancel').on('click', function() {
                $('#confirmModal').fadeOut(300);
            });
            
            // ESC 키로 모달 닫기
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $('#confirmModal').is(':visible')) {
                    $('#confirmModal').fadeOut(300);
                }
            });
            
            // 모달 외부 클릭으로 닫기
            $('#confirmModal').on('click', function(e) {
                if (e.target === this) {
                    $(this).fadeOut(300);
                }
            });
            
            // 예약 확정
            $('.btn-confirm').on('click', function() {
                // hidden 필드들 설정
                const selectedRoom = $('.room-option.selected');
                if (selectedRoom.length > 0) {
                    $('#selectedRoomId').val(selectedRoom.data('room-id'));
                }
                
                // 날짜와 시간을 합쳐서 LocalDateTime 형식으로 설정
                const checkInDateStr = checkInDate.val();
                const checkOutDateStr = checkOutDate.val();
                const checkInTime = houseInfo.checkInTime || '15:00'; // 기본값 15:00
                const checkOutTime = houseInfo.checkOutTime || '11:00'; // 기본값 11:00
                
                $('#reservationStart').val(checkInDateStr + 'T' + checkInTime + ':00');
                $('#reservationEnd').val(checkOutDateStr + 'T' + checkOutTime + ':00');
                
                // 인원 수 설정
                $('#reservationCount').val(guestCount.val());
                
                // 가격 설정 (세금 포함)
                const totalPrice = $('#totalPrice').text().replace(/[^\d]/g, '');
                $('#reservationPrice').val(totalPrice);
                
                const formData = new FormData($('#reservationForm')[0]);
                
                $.ajax({
                    url: '/reservation/house/book',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            alert('예약이 성공적으로 완료되었습니다!');
                            window.location.href = '/member/mypage';
                        } else {
                            alert(response.message || '예약 처리 중 오류가 발생했습니다.');
                        }
                    },
                    error: function() {
                        alert('예약 처리 중 오류가 발생했습니다.');
                    }
                });
            });
        });
    </script>
</main>
</body>
</html>